<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>Word Puzzle</title>
    <script src="hubIndex.js"></script>
    <style>
      body {
        margin: 0;
        background: #111;
        color: #fff;
        font-family: system-ui, sans-serif;
      }
      .hidden {
        display: none !important;
      }
      #app {
        max-width: 420px;
        margin: auto;
        padding: 16px;
      }
      .main-title {
        text-align: center;
        font-size: 34px;
        font-weight: 900;
        margin: 16px 0 6px;
      }
      .subtitle {
        text-align: center;
        font-size: 15px;
        opacity: 0.65;
        margin-bottom: 18px;
      }
      select {
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: none;
        font-size: 16px;
        margin-bottom: 16px;
      }
      .accordion {
        margin-bottom: 14px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.45);
      }
      .accordion-header {
        padding: 14px 16px;
        font-size: 18px;
        font-weight: 800;
        cursor: pointer;
        background: linear-gradient(180deg, #60a5fa, #2563eb);
        color: #04142e;
      }
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        background: #020617;
        transition: max-height 0.35s ease;
      }
      .accordion.open .accordion-content {
        max-height: 900px;
      }
      .group {
        padding: 12px 16px 6px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
      .group-title {
        font-size: 14px;
        font-weight: 700;
        color: #fde68a;
        margin-bottom: 8px;
      }
      .file {
        padding: 12px;
        margin-bottom: 6px;
        border-radius: 12px;
        cursor: pointer;
        background: linear-gradient(180deg, #ffe5d9, #ffb4a2);
        color: #5a1f14;
        font-weight: 700;
      }
      .file.selected {
        outline: 3px solid #60a5fa;
      }
      button {
        width: 100%;
        padding: 14px;
        font-size: 17px;
        font-weight: 700;
        border: none;
        border-radius: 16px;
        cursor: pointer;
        background: linear-gradient(180deg, #9fc5ff, #6fa8ff);
        color: #002b5c;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        margin-bottom: 10px;
      }
      button.secondary {
        background: linear-gradient(180deg, #e0e0e0, #cfcfcf);
        color: #222;
      }
      .btn-green {
        background: linear-gradient(180deg, #bbf7d0, #22c55e);
        color: #052e16;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #gameScreen {
  height: 100dvh;
  display: flex;
  flex-direction: column;
}

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 18px;
      }
      .title {
        text-align: center;
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 10px;
      }
      .card-box {
        background: #020617;
        border-radius: 16px;
        padding: 12px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        margin-bottom: 10px;
      }
      .label {
        font-size: 12px;
        opacity: 0.65;
        margin-bottom: 4px;
      }
      .sentence-view {
        font-size: clamp(20px, 5.8vw, 30px);
        font-weight: 800;
        line-height: 1.25;
      }
      .translation-view {
        font-size: clamp(16px, 4.4vw, 22px);
        opacity: 0.9;
        line-height: 1.3;
      }
      .word-zone {
  min-height: 66px;
  background: #0b1220;
  border-radius: 14px;
  padding: 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-content: flex-start;
  overflow-y: auto;
}

      .word {
        padding: 10px 12px;
        border-radius: 12px;
        font-weight: 700;
        background: linear-gradient(180deg, #ffe5d9, #ffb4a2);
        color: #5a1f14;
        cursor: pointer;
        user-select: none;
      }
      .word.in-sentence {
        background: linear-gradient(180deg, #dbeafe, #93c5fd);
        color: #072f63;
      }
      .small-row {
        display: flex;
        gap: 8px;
      }
      .small-row button {
        margin-bottom: 0;
      }
      .manager-list {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .manager-row {
        background: #0b1220;
        border-radius: 14px;
        padding: 10px;
      }
      .manager-sentence {
        font-weight: 800;
        margin-bottom: 4px;
      }
      .manager-translation {
        opacity: 0.85;
        margin-bottom: 8px;
      }
      .end-box {
        background: #020617;
        border-radius: 16px;
        padding: 16px;
        text-align: center;
        margin-top: 20px;
      }
      .end-box p {
        margin: 8px 0;
        font-size: 18px;
      }
      .notice {
        text-align: center;
        opacity: 0.75;
        margin-top: 8px;
      }

#speakerBox {
  display: flex;
  justify-content: center;
  margin: 10px 0 14px;
}

#speaker {
  font-size: 42px;
  cursor: pointer;
  user-select: none;
}

.manager-row {
  background: #0b1220;
  border-radius: 14px;
  padding: 10px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.manager-texts {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
}

.manager-sentence {
  font-size: 18px;
  font-weight: 800;
}

.manager-translation {
  font-size: 15px;
  opacity: 0.85;
}

.remove-btn {
  width: auto;
  padding: 6px 10px;
  font-size: 16px;
  border-radius: 10px;
  background: linear-gradient(180deg, #fecaca, #ef4444);
  color: #3f0000;
  font-weight: 900;
}

#gameScreen .card-box {
  flex-shrink: 0;
}

#sentenceZone {
  min-height: 72px;
}

#bankZone {
  min-height: 120px;
  max-height: 40vh;
}

@media (max-height: 700px) {
  #app {
    padding: 10px;
  }

  .card-box {
    padding: 10px;
    margin-bottom: 8px;
  }

  .word {
    padding: 8px 10px;
    font-size: 15px;
  }

  #speaker {
    font-size: 36px;
  }
}

#listenText {
  text-align: center;
  margin-top: 4px;
  font-size: 14px;
  opacity: 0.8;
  font-weight: 600;
}


    </style>
  </head>
  <body>
    <div id="app">
      <div id="startScreen">
        <div class="main-title">WORD PUZZLE</div>
        <div class="subtitle">Choose language ¬∑ Pick sentence file ¬∑ Start</div>
        <div class="main-title">TEST - 012</div>

        <select id="langSelect">
          <option value="">Select language‚Ä¶</option>
        </select>
        <div id="accordions"></div>

        <button id="startBtn" class="btn-green hidden">Start Session ‚ñ∂</button>
        <button id="hardSessionBtn" class="hidden">
          Hard Sentences Session üî•
        </button>
        <button id="manageHardBtn" class="secondary">
          Hard Sentences Manager
        </button>
      </div>

      <div id="gameScreen" class="hidden">
        <div class="top-bar">
          <div id="timer">‚è± 0</div>
          <div id="progress">üî¢ 0/0</div>
        </div>

  <div class="card-box">
    <div id="translationText" class="translation-view"></div>
  </div>



 <div class="card-box">
          <div class="label">Build sentence</div>
          <div id="sentenceZone" class="word-zone"></div>
        </div>


       <div class="card-box" id="bankBox">
  <div class="label">Word bank</div>
  <div id="bankZone" class="word-zone"></div>
</div>


       <div id="speakerBox" class="hidden">
  <div id="speaker">üîä</div>
<div id="listenText">Listen</div>
</div>

        <button id="nextBtn" class="btn-green" disabled>Next ‚ñ∂</button>
        <button id="exitBtn" class="secondary">Exit Session</button>
      </div>

      <div id="managerScreen" class="hidden">
        <div class="main-title" style="font-size: 28px">Hard Sentences</div>
        <div class="subtitle">Review and remove hard entries</div>
        <div id="managerList" class="manager-list"></div>
        <div id="managerEmpty" class="notice hidden">
          No hard sentences yet.
        </div>
        <button class="secondary" id="managerBackBtn">Back</button>
      </div>

      <div id="endScreen" class="hidden">
        <div class="main-title" style="font-size: 30px">Session Complete</div>
        <div class="end-box">
          <p id="finalTime"></p>
          <p id="bestTime"></p>
        </div>
        <button id="restartBtn" class="btn-green">Restart</button>
        <button id="endExitBtn" class="secondary">Exit</button>
      </div>
    </div>

    <script>
      const BEST_KEY = "wp_best_time";
      const HARD_KEY = "wp_hard_sentences";

      let selectedMeta = null;
      let selectedSource = null;
      let originalSentences = [];
      let sessionSentences = [];
      let currentIndex = 0;
      let currentTokens = [];
      let bankTokens = [];
      let builtTokens = [];
      let currentWrongAttempts = 0;
      let allWrongCounted = false;
      let startTime = 0;
      let timerInt = null;
      let isHardMode = false;
      let soundEnabled = true;
      let audioCtx = null;

      const langSelect = document.getElementById("langSelect");
      const accordions = document.getElementById("accordions");
      const startBtn = document.getElementById("startBtn");
      const hardSessionBtn = document.getElementById("hardSessionBtn");
      const manageHardBtn = document.getElementById("manageHardBtn");
      const speaker = document.getElementById("speaker");

      function showScreen(id) {
        ["startScreen", "gameScreen", "managerScreen", "endScreen"].forEach(
          (s) => document.getElementById(s).classList.add("hidden"),
        );
        document.getElementById(id).classList.remove("hidden");
      }

      HUB_INDEX.languages.forEach((l) =>
        langSelect.add(new Option(l.title, l.id)),
      );

      langSelect.onchange = () => {
        selectedSource = null;
        selectedMeta = null;
        startBtn.classList.add("hidden");
        hardSessionBtn.classList.add("hidden");
        buildAccordions();
      };

      function buildAccordions() {
        accordions.innerHTML = "";
        const lang = langSelect.value;
        if (!lang) return;

        const byBranch = {};
        HUB_INDEX.entries.forEach((entry) => {
          if (entry.group !== "sentences") return;
          if (!entry.files[lang]) return;
          if (!byBranch[entry.branch]) byBranch[entry.branch] = [];
          byBranch[entry.branch].push(
            ...entry.files[lang].map((file) => ({ group: entry.group, file })),
          );
        });

        Object.keys(byBranch).forEach((branch) => {
          const acc = document.createElement("div");
          acc.className = "accordion";
          acc.innerHTML = `<div class="accordion-header">${branch}</div><div class="accordion-content"></div>`;
          const content = acc.querySelector(".accordion-content");
          acc.querySelector(".accordion-header").onclick = () =>
            acc.classList.toggle("open");

          const g = document.createElement("div");
          g.className = "group";
          g.innerHTML = '<div class="group-title">sentences</div>';

          byBranch[branch].forEach(({ group, file }) => {
            const f = document.createElement("div");
            f.className = "file";
            f.textContent = file.replace(/\.csv$/i, "");
            f.onclick = () => selectFile(f, lang, branch, group, file);
            g.appendChild(f);
          });

          content.appendChild(g);
          accordions.appendChild(acc);
        });
      }

      function selectFile(el, lang, branch, group, file) {
        document
          .querySelectorAll(".file")
          .forEach((f) => f.classList.remove("selected"));
        el.classList.add("selected");
        selectedMeta = { lang, branch, group, file };
        selectedSource = `hub/${lang}/${branch}/${group}/${file}`;
        startBtn.classList.remove("hidden");
        refreshHardButtons();
      }

      function refreshHardButtons() {
        const hasHard = getHardSentences().length > 0;
        hardSessionBtn.classList.toggle("hidden", !selectedSource || !hasHard);
      }

      function getHardStorageKey() {
        return selectedSource
          ? `${HARD_KEY}:${selectedSource}`
          : `${HARD_KEY}:global`;
      }

      function getHardSentences() {
        const key = getHardStorageKey();
        try {
          const parsed = JSON.parse(localStorage.getItem(key) || "[]");
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function setHardSentences(list) {
        localStorage.setItem(getHardStorageKey(), JSON.stringify(list));
        refreshHardButtons();
      }

      function addHardSentence(item) {
        const list = getHardSentences();
        const exists = list.some(
          (x) => x.source === item.source && x.translation === item.translation,
        );
        if (!exists) {
          list.push(item);
          setHardSentences(list);
        }
      }

      startBtn.onclick = () =>
        selectedSource && loadCSVAndStart(selectedSource, false);
      hardSessionBtn.onclick = () => startHardSession();
      manageHardBtn.onclick = () => openHardManager();

      document.getElementById("exitBtn").onclick = exitToStart;
      document.getElementById("restartBtn").onclick = () =>
        startSession(originalSentences.slice(), isHardMode);
      document.getElementById("endExitBtn").onclick = exitToStart;
      document.getElementById("managerBackBtn").onclick = () =>
        showScreen("startScreen");
      document.getElementById("nextBtn").onclick = nextSentence;
      speaker.onclick = speakCurrent;

      function loadCSVAndStart(path, hardMode) {
        fetch(`${path}?v=${Date.now()}`)
          .then((r) => {
            if (!r.ok) throw new Error("CSV load failed");
            return r.text();
          })
          .then((text) => {
            const pairs = text
              .split("\n")
              .map((l) => l.trim())
              .filter(Boolean)
              .map(parseCsvLine)
              .filter(Boolean)
              .map(([a, b]) => ({ source: a, translation: b }));
            startSession(pairs, hardMode);
          })
          .catch((err) => alert(err.message));
      }

      function startHardSession() {
        const hard = getHardSentences();
        if (!hard.length) return;
        startSession(
          hard.map((h) => ({ source: h.source, translation: h.translation })),
          true,
        );
      }

      function startSession(sentences, hardMode) {
        isHardMode = hardMode;
        originalSentences = sentences.slice();
        sessionSentences = shuffle(sentences.slice());
        currentIndex = 0;
        startTime = Date.now();
        clearInterval(timerInt);
        timerInt = setInterval(updateTimer, 1000);
        showScreen("gameScreen");
        loadCurrentSentence();
      }

      function loadCurrentSentence() {
        const row = sessionSentences[currentIndex];
        if (!row) return endSession();

        const translationText = document.getElementById("translationText");
        translationText.textContent = row.translation;
        translationText.dir = isRTL(row.translation) ? "rtl" : "ltr";



        currentTokens = tokenizeSentence(row.source);

const isSentenceRTL = isRTL(row.source);

const sentenceZone = document.getElementById("sentenceZone");
const bankZone = document.getElementById("bankZone");

sentenceZone.dir = isSentenceRTL ? "rtl" : "ltr";
bankZone.dir = isSentenceRTL ? "rtl" : "ltr";

bankTokens = shuffle(
  currentTokens.map((text, idx) => ({ id: `${idx}:${text}`, text })),
);

        builtTokens = [];
        currentWrongAttempts = 0;
        allWrongCounted = false;
        document.getElementById("speakerBox").classList.add("hidden");
        document.getElementById("nextBtn").disabled = true;

        renderTokens();
        renderProgress();
      }

      function tokenizeSentence(text) {
        return text.trim().split(/\s+/).filter(Boolean);
      }

      function renderProgress() {
        document.getElementById("progress").textContent =
          `üî¢ ${currentIndex + 1}/${sessionSentences.length}`;
      }

      function renderTokens() {
        const bankZone = document.getElementById("bankZone");
        const sentenceZone = document.getElementById("sentenceZone");
        bankZone.innerHTML = "";
        sentenceZone.innerHTML = "";

        builtTokens.forEach((tok) =>
          sentenceZone.appendChild(wordEl(tok, true)),
        );
        bankTokens.forEach((tok) => bankZone.appendChild(wordEl(tok, false)));

        checkSentenceState();
      }

      function wordEl(tok, inSentence) {
        const d = document.createElement("div");
        d.className = `word ${inSentence ? "in-sentence" : ""}`;
        d.textContent = tok.text;
        d.ondblclick = () => moveToken(tok.id, inSentence);
        d.onclick = () => moveToken(tok.id, inSentence);
        return d;
      }

      function moveToken(id, fromSentence) {
        playSound("click");
        if (fromSentence) {
          const idx = builtTokens.findIndex((t) => t.id === id);
          if (idx < 0) return;
          bankTokens.push(builtTokens[idx]);
          builtTokens.splice(idx, 1);
        } else {
          const idx = bankTokens.findIndex((t) => t.id === id);
          if (idx < 0) return;
          builtTokens.push(bankTokens[idx]);
          bankTokens.splice(idx, 1);
        }
        renderTokens();
      }

function checkSentenceState() {
  const built = builtTokens.map((t) => t.text).join(" ");
  const target = currentTokens.join(" ");
  const isCorrect = built === target;

  const nextBtn = document.getElementById("nextBtn");
  const wasDisabled = nextBtn.disabled;

  nextBtn.disabled = !isCorrect;
document
  .getElementById("bankBox")
  .classList.toggle("hidden", isCorrect);


  if (isCorrect && wasDisabled) {
    playSound("success");
  }

  document
    .getElementById("speakerBox")
    .classList.toggle("hidden", !isCorrect);


  if (
    builtTokens.length === currentTokens.length &&
    !isCorrect &&
    !allWrongCounted
  ) {
    currentWrongAttempts += 1;
playSound("error");
allWrongCounted = true;

    if (currentWrongAttempts > 2 && !isHardMode) {
      const row = sessionSentences[currentIndex];
      addHardSentence({
        source: row.source,
        translation: row.translation,
      });
    }
  }
}

      function nextSentence() {
        if (document.getElementById("nextBtn").disabled) return;
               currentIndex += 1;
        if (currentIndex >= sessionSentences.length) endSession();
        else loadCurrentSentence();
      }

      function endSession() {
        clearInterval(timerInt);
        const sec = Math.floor((Date.now() - startTime) / 1000);
        const key = selectedSource
          ? `${BEST_KEY}:${selectedSource}${isHardMode ? ":hard" : ""}`
          : BEST_KEY;
        const best = Number(localStorage.getItem(key) || 0);
        const isBest = !best || sec < best;
        if (isBest) localStorage.setItem(key, String(sec));

        document.getElementById("finalTime").textContent =
          `Total time: ${sec}s`;
        document.getElementById("bestTime").textContent =
          `Best time: ${localStorage.getItem(key)}s${isBest ? " üèÜ" : ""}`;
        showScreen("endScreen");
      }

      function exitToStart() {
        clearInterval(timerInt);
        showScreen("startScreen");
        refreshHardButtons();
      }

      function openHardManager() {
        if (!selectedSource) {
          alert("Please select language and file first.");
          return;
        }
        showScreen("managerScreen");
        renderHardManager();
      }

      function renderHardManager() {
        const listEl = document.getElementById("managerList");
        const empty = document.getElementById("managerEmpty");
        const hard = getHardSentences();
        listEl.innerHTML = "";

        if (!hard.length) {
          empty.classList.remove("hidden");
          return;
        }
        empty.classList.add("hidden");

        hard.forEach((item, i) => {
          const row = document.createElement("div");
          row.className = "manager-row";

row.innerHTML = `
  <div class="manager-texts">
    <div class="manager-sentence" dir="${isRTL(item.source) ? "rtl" : "ltr"}">
      ${escapeHtml(item.source)}
    </div>
    <div class="manager-translation" dir="${isRTL(item.translation) ? "rtl" : "ltr"}">
      ${escapeHtml(item.translation)}
    </div>
  </div>
`;

const btn = document.createElement("button");
btn.className = "remove-btn";
btn.textContent = "‚úï";

          btn.onclick = () => {
            const next = getHardSentences();
            next.splice(i, 1);
            setHardSentences(next);
            renderHardManager();
          };
          row.appendChild(btn);
          listEl.appendChild(row);
        });
      }

      function ensureAudio() {
        if (!audioCtx)
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }

      function playSound(type) {
        if (!soundEnabled) return;
        ensureAudio();
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();
        if (type === "success") {
  osc.type = "triangle";
  osc.frequency.setValueAtTime(720, now);
} else if (type === "error") {
  osc.type = "sawtooth";
  osc.frequency.setValueAtTime(220, now);
} else {
  osc.type = "sine";
  osc.frequency.setValueAtTime(420, now);
}

        filter.type = "lowpass";
        filter.frequency.value = 1200;
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(
          type === "success" ? 0.035 : 0.02,
          now + 0.04,
        );
        gain.gain.linearRampToValueAtTime(0, now + 0.26);
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.3);
      }

      function speakCurrent() {
        const utter = new SpeechSynthesisUtterance(currentTokens.join(" "));
        utter.lang = speechLangFromPair(selectedMeta?.lang || "en");
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      }

      function speechLangFromPair(pair) {
        const first = pair.split("-")[0] || "en";
        const map = {
          he: "he-IL",
          en: "en-US",
          ar: "ar-SA",
          es: "es-ES",
          pl: "pl-PL",
        };
        return map[first] || "en-US";
      }

      function updateTimer() {
        document.getElementById("timer").textContent =
          `‚è± ${Math.floor((Date.now() - startTime) / 1000)}`;
      }

      function shuffle(a) {
        const arr = a.slice();
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function isRTL(text) {
        return /[\u0591-\u07FF\uFB1D-\uFDFD\uFE70-\uFEFC]/.test(text || "");
      }

      function parseCsvLine(line) {
        const cells = [];
        let current = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            const next = line[i + 1];
            if (inQuotes && next === '"') {
              current += '"';
              i++;
            } else inQuotes = !inQuotes;
            continue;
          }
          if (char === "," && !inQuotes) {
            cells.push(current.trim());
            current = "";
            continue;
          }
          current += char;
        }
        cells.push(current.trim());
        if (cells.length < 2) return null;
        return [cells[0], cells[1]];
      }

      function escapeHtml(str) {
        return str.replace(
          /[&<>'"]/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              "'": "&#39;",
              '"': "&quot;",
            })[m],
        );
      }
    </script>
  </body>
</html>