<!doctype html>
<html lang="en">
  <head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hebrew with MotiVation</title>

    <style>
      .hidden {
        display: none;
      }

      body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #111;
  color: #fff;
  font-size: 17px;
  line-height: 1.55;
  letter-spacing: 0.3px;
  overflow-y: auto;
  overscroll-behavior: none;
}



      /* ---------- SCREENS ---------- */
      
.screen {
  display: none;
  padding: 18px;
  max-width: 420px;
  margin: auto;
  min-height: 100vh;
  box-sizing: border-box;
  overflow-y: auto;
}

      .screen.active {
        display: block;
      }

      /* ---------- HOME ---------- */
      .welcome {
        font-size: 40px;
        font-weight: 800;
        text-align: center;
        margin-top: 35px;
      }
      .instructions {
        text-align: center;
        font-size: 25px;
        margin: 20px 0 30px;
        color: #bbb;
      }
      .title-bottom {
        text-align: center;
        font-size: 30px;
        margin-top: 28px;
        opacity: 0.85;
      }

      /* ---------- BUTTONS ---------- */
      button {
        width: 100%;
        padding: 14px;
        margin: 8px 0;
        font-size: 17px;
        font-weight: 600;
        letter-spacing: 0.3px;
        border: none;
        border-radius: 14px;
        cursor: pointer;
        background: linear-gradient(180deg, #f1f4f8, #dfe7f1);
        color: #222;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        transition:
          transform 0.1s,
          box-shadow 0.1s,
          background 0.2s;
      }
      button:hover {
        background: linear-gradient(180deg, #ffffff, #e6eef8);
      }
      button:active {
        transform: translateY(2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.35);
      }

      .forest {
        background: linear-gradient(180deg, #bbf7d0, #22c55e);
        color: #052e16;
      }

      .back {
        background: linear-gradient(180deg, #e0e0e0, #cfcfcf);
      }
      .button-danger {
        background: linear-gradient(180deg, #ff9aa2, #ff6f6f);
        color: #300;
      }

      .button-primary {
        background: linear-gradient(180deg, #9fc5ff, #6fa8ff);
        color: #002b5c;
      }

      .button-success {
        background: linear-gradient(180deg, #b7e4c7, #95d5b2);
        color: #103b24;
      }

      .button-bank {
        background: linear-gradient(180deg, #b7e4c7, #95d5b2);
        color: #103b24;
      }

      .peach {
        background: linear-gradient(180deg, #ffe5d9, #ffb4a2);
        color: #5a1f14;
      }
      .sunset {
        background: linear-gradient(180deg, #ffedd5, #fb923c);
        color: #4a1d00;
      }

      .lavender {
        background: linear-gradient(180deg, #ede9fe, #c4b5fd);
        color: #2e1065;
      }

      /* ---------- FORM ---------- */
      select,
      input,
      textarea {
        width: 100%;
        padding: 13px;
        margin: 8px 0;
        font-size: 17px;
        border-radius: 10px;
        border: none;
        box-sizing: border-box;
      }

      /* ---------- SESSION ---------- */

      .flip-hint {
        text-align: center;
        font-family: "Comic Sans MS", "Trebuchet MS", cursive;
        font-size: 30px;
        margin-bottom: 10px;
        color: #ffd966;
      }

      .card-frame {
        border: 5px solid #6fa8dc;
        border-radius: 18px;
        padding: 14px;
        background: #2a2a2a;
        box-shadow:
          0 10px 18px rgba(0, 0, 0, 0.6),
          inset 0 0 0 2px rgba(255, 255, 255, 0.08);
      }

      .card {
        background: #111;
        height: 220px; /* ◊õ◊®◊ò◊ô◊° ◊ß◊ë◊ï◊¢ */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 102px; /* ◊§◊ô 3 */
        line-height: 1.15;
        text-align: center;
        border-radius: 12px;
        padding: 20px;
        user-select: none;

        overflow: hidden; /* ◊î◊õ◊®◊ò◊ô◊° ◊ú◊ê ◊í◊ì◊ú */
        white-space: normal; /* ◊û◊ï◊™◊® ◊ú◊©◊ë◊ï◊® ◊©◊ï◊®◊î */
        word-break: normal; /* ‚ùå ◊ú◊ê ◊©◊ï◊ë◊®◊ô◊ù ◊û◊ô◊ú◊î */
        overflow-wrap: normal; /* ‚ùå ◊ú◊ê ◊©◊ï◊ë◊®◊ô◊ù ◊û◊ô◊ú◊î */
      }

      .remaining {
        text-align: center;
        font-size: 20px;
        margin-top: 10px;
        color: #cfe2f3;
      }

      .row {
        display: flex;
        gap: 10px;
        margin-top: 14px;
      }
      .row button {
        width: 50%;
      }

      /* ---------- BANK ---------- */

      .word-files-invite {
        border: 2px solid #ffd966;
        border-radius: 18px;
        padding: 16px;
        margin: 16px 0;
        background: linear-gradient(180deg, #1f1f1f, #151515);
        box-shadow: 0 0 18px rgba(255, 217, 102, 0.25);
      }
      .word-files-invite h3 {
        text-align: center;
        font-size: 22px;
        color: #ffe599;
        margin-bottom: 6px;
      }
      .invite-main {
        text-align: center;
        font-size: 15px;
        margin-bottom: 10px;
      }
      .invite-cta {
        text-align: center;
        font-size: 17px;
        font-weight: 700;
        letter-spacing: 0.3px;
        padding: 12px;
        border-radius: 14px;
        background: linear-gradient(180deg, #9fc5ff, #6fa8ff);
        color: #002b5c;
        cursor: pointer;

        transition:
          transform 0.15s ease,
          box-shadow 0.15s ease,
          opacity 0.15s ease;
      }

      .invite-cta:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        opacity: 0.95;
      }

      .invite-cta:active {
        transform: translateY(1px);
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35);
      }

      /* ---------- DOWNLOAD ---------- */

      #download select {
        margin-bottom: 14px;
        background: #1c1c1c;
        color: #fff;
      }

      #download h2 {
        text-align: center;
        margin-bottom: 14px;
      }

      #downloadAccordions li {
        cursor: pointer;
        padding: 8px 6px;
        border-radius: 8px;
        transition:
          background 0.15s,
          color 0.15s;
      }

      #downloadAccordions li:hover {
        background: #2a2a2a;
        color: #ffe5d9; /* peach tone */
      }

      #downloadAccordions li:active {
        background: #333;
      }

      /* --- Download language visual state --- */

      #downloadLangSelect {
        transition:
          box-shadow 0.15s ease,
          border-color 0.15s ease;
      }

      /* ◊°◊ô◊û◊ï◊ü ◊¢◊ì◊ô◊ü ◊ú◊§◊ô ◊©◊§◊î */
      #downloadLangSelect.lang-he-en {
        box-shadow: 0 0 0 2px rgba(187, 247, 208, 0.5); /* forest */
      }
      #downloadLangSelect.lang-pl-en {
        box-shadow: 0 0 0 2px rgba(255, 229, 217, 0.55); /* peach */
      }
      #downloadLangSelect.lang-ar-he {
        box-shadow: 0 0 0 2px rgba(255, 237, 213, 0.55); /* sunset */
      }
      #downloadLangSelect.lang-es-he {
        box-shadow: 0 0 0 2px rgba(187, 247, 208, 0.35); /* forest soft */
      }
      .li-available {
        background: linear-gradient(180deg, #bbf7d0, #22c55e);
        color: #052e16;
        font-weight: 700;
      }

      .li-locked {
        opacity: 0.35;
        cursor: not-allowed;
      }

      /* ---------- DOWNLOAD STRUCTURE ---------- */

      .download-lang-box {
        background: linear-gradient(180deg, #1f2933, #161c22);
        border: 2px solid #6fa8dc;
        border-radius: 16px;
        padding: 14px;
        margin-bottom: 16px;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
      }

      .download-lang-title {
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 0.4px;
        margin-bottom: 8px;
        color: #9fc5ff;
        text-align: center;
      }

      .download-divider {
        height: 1px;
        background: linear-gradient(
          to right,
          transparent,
          #6fa8dc,
          transparent
        );
        margin: 10px 0 14px;
        opacity: 0.8;
      }

      .download-topics-title {
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 0.4px;
        margin-bottom: 8px;
        color: #ffd966;
        text-align: center;
      }

      /* ---------- ACCORDION ---------- */

      #downloadAccordions.lang-not-selected {
        opacity: 0.4;
        pointer-events: none;
      }

      .accordion {
        border-radius: 14px;
        background: #1c1c1c;
        margin-bottom: 10px;
        overflow: hidden;
      }

      .accordion-header {
        padding: 14px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .accordion-header span {
        transition: transform 0.25s ease;
      }

      .accordion.open .accordion-header span {
        transform: rotate(90deg);
      }

      .accordion-content {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transform: translateY(-4px);
        transition:
          max-height 0.35s ease,
          opacity 0.25s ease,
          transform 0.25s ease;
      }

      .accordion.open .accordion-content {
        max-height: 1000px;
        opacity: 1;
        transform: translateY(0);
        padding-bottom: 12px;
      }

      .accordion-content ul {
        margin: 0;
        padding-left: 18px;
        font-size: 14px;
        line-height: 1.45;
      }

      .accordion-has-files > .accordion-header {
        background: linear-gradient(180deg, #bbf7d0, #22c55e);
        color: #052e16;
      }

      /* ---------- LIST ---------- */

      #bankListTopicSelect {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        font-size: 16px;

        border-radius: 10px;
        border: none;
        box-sizing: border-box;

        position: relative;
        z-index: 10; /* üî• ◊ß◊®◊ô◊ò◊ô */
      }

      .list-item {
        background: #222;
        padding: 17px;
        margin: 8px 0;
        border-radius: 10px;
      }

      .word-line {
        font-size: 33px;
        font-weight: 600;
        line-height: 1.3;
      }

      .actions {
        display: flex;
        gap: 8px;
      }

      .actions button {
        width: 50%;
      }

 

      /* ---------- CONTACT ---------- */
      .contact button {
        background: linear-gradient(180deg, #e6e6e6, #cfcfcf);
        color: #222;
        font-weight: 700;
      }

      .about-box {
        border: 2px solid #6fa8dc;
        border-radius: 18px;
        padding: 16px;
        margin-top: 20px;
        background: #1c1c1c;
        text-align: center;
      }

      .about-title {
        font-size: 22px;
        font-weight: 800;
        margin-bottom: 10px;
        color: #9fc5ff;
      }

      .about-box p {
        margin: 10px 0;
        font-size: 15px;
        line-height: 1.4;
      }

      .stat-block {
        background: #1c1c1c;
        padding: 10px;
        margin: 8px 0;
        border-radius: 10px;
      }

      /* ---------- CONTACT   LINKS ---------- */
      .contact-links {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin: 16px 0;
      }

      .contact-links a {
        display: block;
        text-align: center;
        padding: 14px;
        border-radius: 14px;
        font-size: 16px;
        font-weight: 700;
        color: #fff;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        transition:
          opacity 0.2s,
          transform 0.1s;
      }

      .contact-links a:hover {
        opacity: 0.9;
      }

      .contact-links a:active {
        transform: translateY(2px);
      }

      /* Colors */
      .contact-links a.facebook {
        background: #1877f2;
      }

      .contact-links a.instagram {
        background: linear-gradient(45deg, #f58529, #dd2a7b, #8134af);
      }

      .contact-links a.whatsapp {
        background: #25d366;
      }

      .contact-links a.email {
        background: #6b7280;
      }

      /* --- HARD WORDS TABLE --- */
      .hard-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      .hard-table th {
        text-align: left;
        padding: 8px;
        border-bottom: 2px solid #555;
        font-size: 16px;
      }
      .hard-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #333;
        vertical-align: top;
      }
      .hard-word {
        font-size: 20px;
        font-weight: 600;
      }
      .hard-count {
        text-align: center;
        font-size: 18px;
      }

      .sound-toggle {
        text-align: center;
        font-size: 22px;
        margin: 10px 0 6px;
        cursor: pointer;
        user-select: none;
        opacity: 0.85;
      }
      .sound-toggle:hover {
        opacity: 1;
      }

      #sessionEnd.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .session-end-box {
        text-align: center;
        max-width: 320px;
      }

      .session-end-box h1 {
        font-size: 36px;
        margin-bottom: 10px;
      }

      .session-end-sub {
        font-size: 18px;
        opacity: 0.85;
        margin-bottom: 24px;
      }
    </style>
  </head>

  <body>
    <!-- HOME -->
    <div class="screen active" id="home">
      <div class="welcome">WELCOME</div>
      <br />

      <div id="instructions" class="instructions">
        To start, add words OR load a file in the Word Bank
      </div>

      <select id="topicSelect"></select>
      <button class="button-primary" onclick="startSessionSafe(topicSelect.value)">
  Start Session
</button>

      <button class="peach" onclick="showBank()">Word Bank</button>
      <button class="lavender" onclick="showStats()">Statistics</button>
      <button class="forest" onclick="showContact()">Contact</button>
      <button onclick="exitApp()" class="back">Exit</button>

      <div class="title-bottom">Hebrew with MotiVation</div>
<div style="text-align:center;opacity:.4">TEST - 44</div>

      <div
        id="cacheVersion"
        style="
          text-align: center;
          font-size: 13px;
          opacity: 0.5;
          margin-top: 20px;
        "
      ></div>
    </div>


<!-- RESET -->
<div class="screen" id="resetGate">
  <h2>Update</h2>

  <button class="SUNSET" onclick="hardReset()">
    Reset App
  </button>
</div>


    <!-- BANK -->
    <div class="screen" id="bank">
      <h2>Word Bank</h2>
      <select id="bankTopicSelect"></select>
      <button class="sunset" onclick="showAdd()">Add words / topic</button>

      <div class="word-files-invite">
        <button class="invite-cta" onclick="showDownload()">
          Word Library
        </button>
      </div>

      <button class="peach" onclick="triggerImport()">Import word file</button>

      <button onclick="goHome()" class="back">Back</button>
    </div>

    <!-- ACCORDIONS  -->
    <div class="screen" id="download">
      <h2>WORD LIBRARY</h2>

      <div class="download-lang-box">
        <div class="download-lang-title">Choose language</div>

        <select id="downloadLangSelect">
          <option value="" hidden>Choose language pair</option>
          <option value="he-en">Hebrew ‚Üí English</option>
          <option value="pl-en">Polish ‚Üí English</option>
          <option value="ar-he">Arabic ‚Üí Hebrew</option>
          <option value="es-he">Spanish ‚Üí Hebrew</option>
        </select>
      </div>

      <div class="download-divider"></div>

      <div class="download-topics-title">Choose topic</div>

      <div id="downloadAccordions"></div>

      <button class="back" onclick="goHome()">Back</button>
    </div>

    <!-- BANK LIST -->

    <div class="screen" id="bankList">
      <select
        id="bankListTopicSelect"
      ></select>

      <button onclick="addWordToCurrentTopic()" class="forest">
        + Add word
      </button>

      <button class="lavender" onclick="exportCurrentTopic()">
        Export word file
      </button>

      <div style="display: flex; gap: 8px">
        <button class="peach" style="flex: 1" onclick="renameCurrentTopic()">
          Rename
        </button>
        <button
          id="deleteTopicBtn"
          class="button-danger"
          style="flex: 1"
          onclick="deleteCurrentTopic()"
        >
          Delete
        </button>
      </div>

      <button class="back" style="font-weight: 700" onclick="goHome()">
        Back
      </button>

      <input
        id="searchInput"
        placeholder="Search..."
        oninput="renderWordList()"
      />
      <select id="sortSelect" onchange="renderWordList()">
        <option value="">No sorting</option>
        <option value="learn">By learning language</option>
        <option value="tr">By translation</option>
      </select>

      <div id="wordList"></div>

      <button onclick="showBank()" class="back">Back</button>
    </div>

    <!-- ADD -->
    <div class="screen" id="add">
      <h2>Add word</h2>
      <select id="addTopicSelect" onchange="onAddTopicChange()"></select>
      <input id="newTopicInput" class="hidden" placeholder="New topic name" />
      <textarea id="learnInput" placeholder="Learning language"></textarea>
      <textarea id="translationInput" placeholder="Translation"></textarea>
      <button class="forest" onclick="saveWord()">Save</button>
      <button onclick="goHome()" class="back">Back</button>
    </div>

    <!-- SESSION -->
    <div class="screen" id="session">
      <div class="flip-hint">CLICK TO FLIP</div>

      <div class="card-frame">
        <div class="card" id="card" onclick="flipCard()"></div>
      </div>

      <div class="remaining">Remaining: <span id="remainingCount"></span></div>

      <div class="sound-toggle" onclick="toggleSound()" id="soundIcon">üîä</div>

      <div class="row">
        <button class="forest" onclick="markKnown()">I knew it</button>
        <button class="button-danger" onclick="markUnknown()">Ooooopsi</button>
      </div>

      <button class="lavender" id="shuffleBtn" onclick="shuffleSession()">
        Shuffle
      </button>
      <button class="sunset" onclick="flipDirection()">Flip Direction</button>
      <button onclick="exitSessionSafe('home')" class="back">Exit</button>

    </div>

    <!-- SESSION END -->
    <div class="screen" id="sessionEnd">
      <div class="session-end-box">
        <h1>üéâ Well done üéâ</h1>
        <p class="session-end-sub">You‚Äôve completed the session</p>

        <button class="forest" id="restartSessionBtn">Start again</button>

        <button onclick="exitSessionSafe('home')" class="back">Exit</button>

      </div>
    </div>

    <!-- STATS -->
    <div class="screen" id="stats">
      <h2>Statistics</h2>
      <button onclick="resetStats()" class="button-danger">
        Reset statistics
      </button>
      <div id="statsContent"></div>
      <button onclick="goHome()" class="back">Back</button>
    </div>

    <!-- CONTACT -->
    <div class="screen contact" id="contact">

      <div class="about-box">
        <div class="about-title">Hebrew with Moti Vation</div>

        <p>
          I'm here ‚Äì No Fear<br />
          Hebrew will become so clear
        </p>

        <p>
          Online sessions from the comfort of your home<br />
          Beginners / Advanced / Individuals / Groups
        </p>

        <p>
          Fun & Interesting lessons<br />
          I love languages and I love teaching
        </p>

        <p>
          Lets go on adventure..<br />
          Cake Eat Easy<br />
          Take care ‚Äì Take air
        </p>
      </div>

      <div class="contact-links">
        <a
          class="facebook"
          href="https://www.facebook.com/share/1D6uJLL5nK/"
          target="_blank"
  
      >
          Facebook
        </a>

        <a
          class="instagram"
          href="https://www.instagram.com/hebrew_with_motivation"
          target="_blank"
        >
          Instagram
        </a>

        <a class="email" href="mailto:mottex@gmail.com"> Email </a>

        <a class="whatsapp" href="https://wa.me/48604726360" target="_blank">
          WhatsApp
        </a>
      </div>

      <button onclick="goHome()" class="back">Back</button>
    </div>

    <input type="file" id="importFile" accept=".csv" class="hidden" />

    <script src="hubIndex.js"></script>
    

    <script>

 /* ===== STORAGE CONSTANTS ===== */
const STORAGE_VERSION = "v333";
const FLASH_KEY = `flashData_${STORAGE_VERSION}`;
const STATS_KEY = `stats_${STORAGE_VERSION}`;
const RESET_FLAG = "APP_RESET_DONE_v333";

if ("scrollRestoration" in history) {
  history.scrollRestoration = "manual";
}


      /* ===== SOUND ===== */

      let soundOn = JSON.parse(localStorage.getItem("soundOn") ?? "true");
      // very soft sounds

      const flipSound = new Audio(
        "https://actions.google.com/sounds/v1/impacts/metal_parts_cling.ogg",
      );
      const correctSound = new Audio(
        "https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg",
      );

      flipSound.volume = 0.2;
      correctSound.volume = 0.07;

      function toggleSound() {
        soundOn = !soundOn;
        localStorage.setItem("soundOn", JSON.stringify(soundOn));
        updateSoundIcon();
      }

      function updateSoundIcon() {
        const el = document.getElementById("soundIcon");
        if (el) el.textContent = soundOn ? "üîä" : "üîá";
      }

      /* ===== DATA ===== */


let data = JSON.parse(localStorage.getItem(FLASH_KEY)) || {
  topics: {},
};
let stats = JSON.parse(localStorage.getItem(STATS_KEY)) || {
  sessions: 0,
  history: [],
  perTopic: {},
  hardWords: {},
};


      const topicSelect = document.getElementById("topicSelect");

topicSelect.onchange = function () {
  setCurrentTopic(this.value);
};

      const bankTopicSelect = document.getElementById("bankTopicSelect");
      const bankListTopicSelect = document.getElementById(
        "bankListTopicSelect",
      );
bankListTopicSelect.onchange = switchBankListTopic;

      const searchInput = document.getElementById("searchInput");
      const sortSelect = document.getElementById("sortSelect");
      const wordList = document.getElementById("wordList");
      const addTopicSelect = document.getElementById("addTopicSelect");
      const learnInput = document.getElementById("learnInput");
      const translationInput = document.getElementById("translationInput");
      const newTopicInput = document.getElementById("newTopicInput");
      const importFile = document.getElementById("importFile");
      const shuffleBtn = document.getElementById("shuffleBtn");
      const card = document.getElementById("card");

/* ===== HUB INDEX ===== */

// guard ‚Äì ◊ë◊ì◊ô◊ß◊î ◊©◊î◊°◊§◊®◊ô◊ô◊î ◊†◊ò◊¢◊†◊î


function ensureHubLoaded() {
  if (!window.HUB_INDEX) {
    alert("Word Library is not available right now.");
    return false;
  }
  return true;
}

// state
let hubIndex = null;
let currentTopic = null;
let lastAddTopic = null;



      /* ===== UTIL ===== */

      function save() {
        localStorage.setItem(FLASH_KEY, JSON.stringify(data));
localStorage.setItem(STATS_KEY, JSON.stringify(stats));

      }

function setCurrentTopic(topicName) {
   currentTopic = topicName || null;

  // ◊°◊†◊õ◊®◊ï◊ü UI
  if (topicSelect) topicSelect.value = topicName || "";
  if (bankTopicSelect) bankTopicSelect.value = topicName || "";
  if (bankListTopicSelect) bankListTopicSelect.value = topicName || "";
}


      /* ===== TOPIC NAME GATE ===== */

      function normalizeTopicName(name) {
        return name
          .trim()
          .replace(/\s+/g, " ") // ◊®◊ï◊ï◊ó◊ô◊ù ◊õ◊§◊ï◊ú◊ô◊ù ‚Üí ◊®◊ï◊ï◊ó ◊ê◊ó◊ì
          .toLowerCase(); // ◊ë◊ú◊ô ◊î◊ë◊ì◊ú ◊ê◊ï◊™◊ô◊ï◊™
      }

      /*
mode:
- "create"  ‚Üí ◊ô◊¶◊ô◊®◊™ ◊ò◊ï◊§◊ô◊ß ◊ó◊ì◊© (ADD / IMPORT / DOWNLOAD)
- "rename"  ‚Üí ◊©◊ô◊†◊ï◊ô ◊©◊ù ◊ò◊ï◊§◊ô◊ß
*/
      function validateTopicName(name, mode, currentName = null) {
        const n = normalizeTopicName(name);

        if (!n) {
          alert("Topic name is empty");
          return null;
        }

        // ◊ô◊¶◊ô◊®◊™ ◊ò◊ï◊§◊ô◊ß ◊ó◊ì◊©
        if (mode === "create") {
          if (data.topics[n]) {
            alert(`Topic "${n}" already exists`);
            return null;
          }
          return n;
        }

        // ◊©◊ô◊†◊ï◊ô ◊©◊ù
        if (mode === "rename") {
          if (n === currentName) return n; // ◊ê◊ï◊™◊ï ◊©◊ù ‚Äì ◊û◊ï◊™◊®
          if (data.topics[n]) {
            alert(`Topic "${n}" already exists`);
            return null;
          }
          return n;
        }

        console.error("Unknown topic name validation mode:", mode);
        return null;
      }

      function allWords() {
        let a = [];
        Object.keys(data.topics).forEach((t) => {
          if (t !== "All words") a.push(...data.topics[t]);
        });
        return a;
      }

      /* ===== LIBRARY ‚Üí FC TOPIC ===== */
      function saveCSVAsTopic(csvText, topicName) {
        // üîí ◊ó◊°◊ô◊û◊î ◊û◊ô◊ô◊ì◊ô◊™ ‚Äì ◊©◊ù ◊ò◊ï◊§◊ô◊ß ◊õ◊ë◊® ◊ß◊ô◊ô◊ù
        const checked = validateTopicName(topicName, "create");
        if (!checked) {
          alert("This file was already loaded");
          return false;
        }

        const rows = csvText.split(/\r?\n/);
const words = [];

rows.forEach((line) => {
  if (!line.trim()) return;

  const p = line.split(",");
  if (p.length >= 2) {
    words.push({
      id: Date.now() + Math.random(),
      learn: p[0].replace(/"/g, "").trim(),
      tr: p.slice(1).join(",").replace(/"/g, "").trim(),
    });
  }
});

        if (words.length === 0) {
          alert("File contains no valid words");
          return false;
        }

        if (data.topics[topicName]) {
          alert("Topic already exists. File not loaded.");
          return false;
        }

        data.topics[topicName] = words;

        save();
        loadTopics();

        return true;
      }

      /* ===== NAV ===== */
      function show(id) {
        document
          .querySelectorAll(".screen")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
      }

function showBank() {
  resetBankSearch();
  loadTopics();
  show("bank");
}


      function showStats() {
        renderStats();
        show("stats");
      }
      function showContact() {
        show("contact");
      }

      function showDownload() {

if (stats.current) {
  exitSessionSafe("download");
  return;
}

  if (!ensureHubLoaded()) return;

        // ◊ê◊ô◊§◊ï◊° ◊©◊§◊î
        currentDownloadLang = null;

        // ◊ê◊ô◊§◊ï◊° ◊ë◊ó◊ô◊®◊î ◊ï◊°◊ò◊ô◊ô◊ú ◊©◊ú ◊î◊©◊§◊î
        if (downloadLangSelect) {
          downloadLangSelect.value = "";
        }

        // ◊ë◊†◊ô◊ô◊™ UI ◊©◊ú ◊î◊ê◊ß◊ï◊®◊ì◊ô◊ï◊†◊ô◊ù
        buildDownloadUI();

        // ◊û◊¶◊ë ◊ê◊§◊ï◊® ‚Äì ◊†◊ï◊©◊ê◊ô◊ù ◊†◊¢◊ï◊ú◊ô◊ù ◊¢◊ì ◊ë◊ó◊ô◊®◊™ ◊©◊§◊î
        const acc = document.getElementById("downloadAccordions");
        if (acc) {
          acc.classList.add("lang-not-selected");
        }

        // ◊¢◊ì◊õ◊ï◊ü ◊°◊ò◊ô◊ô◊ú ◊©◊ú select (◊û◊ï◊®◊ô◊ì ◊õ◊ú ◊°◊ô◊û◊ï◊ü ◊ß◊ï◊ì◊ù)
        markActiveDownloadLang();

        // ◊°◊í◊ô◊®◊™ ◊õ◊ú ◊î◊ê◊ß◊ï◊®◊ì◊ô◊ï◊†◊ô◊ù
        closeAllAccordions();

        // ◊î◊¶◊í◊™ ◊î◊û◊°◊ö
        show("download");
      }

function goHome() {
  resetBankSearch();
  exitSessionSafe("home");
  loadTopics();
  updateInstructions();
}


      /* ===== HOME LOGIC ===== */
      function updateInstructions() {
        document
          .getElementById("instructions")
          .classList.toggle("hidden", allWords().length > 0);
      }

      /* ===== TOPICS ===== */

      function loadTopics() {
  const hardLabel = "Hard Words";

  const baseTopics = Object.keys(data.topics).filter(
    (t) => t !== "All words",
  );

  const isBankEmpty = baseTopics.length === 0;

  /* ---------- HOME ---------- */
  topicSelect.innerHTML = '<option value="">Select topic</option>';
  topicSelect.innerHTML += `<option>${hardLabel}</option>`;
  baseTopics.forEach((t) => {
    topicSelect.innerHTML += `<option>${t}</option>`;
  });

  /* ---------- BANK ---------- */
  bankTopicSelect.innerHTML = '<option value="">Select topic</option>';
  baseTopics.forEach((t) => {
    bankTopicSelect.innerHTML += `<option>${t}</option>`;
  });

  /* ---------- BANK LIST ---------- */
  bankListTopicSelect.innerHTML = "";
  baseTopics.forEach((t) => {
    bankListTopicSelect.innerHTML += `<option>${t}</option>`;
  });

  if (currentTopic && baseTopics.includes(currentTopic)) {
    bankListTopicSelect.value = currentTopic;
  }

  /* ---------- EMPTY BANK GUARD ---------- */
  if (isBankEmpty) {
    topicSelect.disabled = true;
    bankTopicSelect.disabled = true;
    bankListTopicSelect.innerHTML = "";
  } else {
    topicSelect.disabled = false;
    bankTopicSelect.disabled = false;
  }
}


      /* ===== BANK ===== */

function resetBankSearch() {
  if (searchInput) searchInput.value = "";
  if (sortSelect) sortSelect.value = "";
}



function switchBankListTopic() {
  const t = bankListTopicSelect.value;
  if (!t) return;

  setCurrentTopic(t);

  if (t === "Hard Words") {
    renderHardWordsList();
    show("bankList");
    return;
  }

  renderWordList();
  show("bankList");
}


function renderHardWordsList() {
  wordList.innerHTML = "";

  const entries = Object.entries(stats.hardWords)
    .filter(e => e[1] >= 2)
    .sort((a, b) => b[1] - a[1]);

  if (!entries.length) {
    wordList.innerHTML = "<p>No hard words.</p>";
    return;
  }

  entries.forEach(([key, count], i) => {
    const [learn, tr] = key.split("||");

    wordList.innerHTML += `
      <div class="list-item">
        <div class="word-line">
          ${i + 1}. ${learn} ‚Äì ${tr}
        </div>
        <div class="actions">
          <button style="font-size:12px;padding:6px;"
            onclick="removeHardWord('${key.replace(/'/g, "\\'")}')">
            Remove
          </button>
          <span style="opacity:.6;font-size:12px;">${count}√ó</span>
        </div>
      </div>`;
  });
}


      function renameCurrentTopic() {

        if (!currentTopic || currentTopic === "All words") return;

        const oldKey = normalizeTopicName(currentTopic);
        const input = prompt("New topic name:", currentTopic);
        if (!input) return;

        const newKey = normalizeTopicName(input);

        // ◊ê◊ï◊™◊ï ◊û◊§◊™◊ó ◊ë◊§◊ï◊¢◊ú
        if (newKey === oldKey) return;

        // ◊ß◊ô◊ô◊ù ◊õ◊ë◊®
        if (data.topics[newKey]) {
          alert("Topic name already exists. Rename cancelled.");
          return;
        }

        // ◊î◊¢◊ë◊®◊î
        data.topics[newKey] = data.topics[oldKey];
        delete data.topics[oldKey];

        // ◊¢◊ì◊õ◊ï◊ü state
        setCurrentTopic(newKey);
        lastAddTopic = newKey;

        // ◊°◊ò◊ò◊ô◊°◊ò◊ô◊ß◊î
        if (stats.perTopic[oldKey]) {
          stats.perTopic[newKey] = stats.perTopic[oldKey];
          delete stats.perTopic[oldKey];
        }
        if (stats.current && stats.current.topic === oldKey) {
          stats.current.topic = newKey;
        }

        save();
        loadTopics();
        renderWordList();
      }

      function addWordToCurrentTopic() {
        if (!currentTopic) return;

        lastAddTopic = currentTopic;
        showAdd();
      }
      };

      function renderWordList() {

  let q = searchInput.value.toLowerCase();
  let sort = sortSelect.value;
  wordList.innerHTML = "";

  let arr = [...data.topics[currentTopic]];

  if (q) {
    arr = arr.filter(
      (w) =>
        w.learn.toLowerCase().includes(q) ||
        w.tr.toLowerCase().includes(q)
    );
  }

  if (sort === "learn") {
    arr.sort((a, b) => a.learn.localeCompare(b.learn));
  }
  if (sort === "tr") {
    arr.sort((a, b) => a.tr.localeCompare(b.tr));
  }

  arr.forEach((w, i) => {
    wordList.innerHTML += `
      <div class="list-item">
        <div class="word-line">
          ${i + 1}. ${w.learn} ‚Äì ${w.tr}
        </div>
        <div class="actions">
          <button style="font-size:12px;padding:6px;" onclick="editWord(${w.id})">Edit</button>
          <button style="font-size:12px;padding:6px;" onclick="deleteWord(${w.id})">Delete</button>
        </div>
      </div>`;
  });
}


      function exportCurrentTopic() {
        let rows = ["Learning language,Translation"];
        data.topics[currentTopic].forEach((w) =>
          rows.push(`"${w.learn}","${w.tr}"`),
        );
        let blob = new Blob([rows.join("\n")], { type: "text/csv" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${currentTopic}.csv`;
        a.click();
      }

      function deleteCurrentTopic() {
        if (confirm("Delete this topic and all its words?")) {
          delete data.topics[currentTopic];
          save();
          showBank();
        }
      }

      function deleteWord(id) {
        data.topics[currentTopic] = data.topics[currentTopic].filter(
          (w) => w.id !== id,
        );
        save();
        renderWordList();
      }

      function editWord(id) {
        returnToBankListAfterSave = true;
        const w = data.topics[currentTopic].find((x) => x.id === id);
        deleteWord(id);
        showAdd();
        addTopicSelect.value = currentTopic;
        onAddTopicChange();
        learnInput.value = w.learn;
        translationInput.value = w.tr;
      }
      /* ===== ADD WORD ===== */

      function showAdd() {
  resetBankSearch();

  learnInput.value = "";
  translationInput.value = "";
  newTopicInput.value = "";
  newTopicInput.disabled = true;
  newTopicInput.classList.add("hidden");

  loadAddTopics();
  show("add");
}


      function loadAddTopics() {
        addTopicSelect.innerHTML = "";

        addTopicSelect.innerHTML += `<option value="">Select topic</option>`;
        addTopicSelect.innerHTML += `<option value="_new">+ New topic</option>`;

        Object.keys(data.topics).forEach((t) => {
          if (t !== "All words") {
            addTopicSelect.innerHTML += `<option value="${t}">${t}</option>`;
          }
        });

        if (lastAddTopic && data.topics[lastAddTopic]) {
          addTopicSelect.value = lastAddTopic;
        } else {
          addTopicSelect.value = "";
        }

        onAddTopicChange();
      }

      function onAddTopicChange() {
        const isNew = addTopicSelect.value === "_new";

        newTopicInput.disabled = !isNew;
        newTopicInput.classList.toggle("hidden", !isNew);

        if (!isNew) {
          newTopicInput.value = "";
        }
      }

      function saveWord() {
  const isNew = addTopicSelect.value === "_new";
  const topicName = isNew
    ? newTopicInput.value.trim()
    : addTopicSelect.value;

  if (!topicName) return;
  if (!learnInput.value || !translationInput.value) return;

  if (isNew && data.topics[topicName]) {
    alert("Topic already exists");
    return;
  }

  if (!data.topics[topicName]) {
    data.topics[topicName] = [];
  }

  data.topics[topicName].push({
    id: Date.now() + Math.random(),
    learn: learnInput.value,
    tr: translationInput.value,
  });

  lastAddTopic = topicName;
  setCurrentTopic(topicName);

  save();
  loadTopics();
  updateInstructions();

  learnInput.value = "";
  translationInput.value = "";
  newTopicInput.value = "";

  loadAddTopics();
  addTopicSelect.value = topicName;
  onAddTopicChange();
}


      /* ===== IMPORT ===== */

      function triggerImport() {
        importFile.click();
      }

      importFile.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) {
          importFile.value = "";
          return;
        }

        // üî• ◊©◊ù ◊î◊†◊ï◊©◊ê = ◊©◊ù ◊î◊ß◊ï◊ë◊• ◊ë◊ú◊ô ◊°◊ô◊ï◊û◊™
        const topic = file.name.replace(/\.[^/.]+$/, "");

        // ◊ô◊¶◊ô◊®◊™ ◊†◊ï◊©◊ê ◊ó◊ì◊© (◊ê◊ï ◊†◊ô◊ß◊ï◊ô ◊ß◊ô◊ô◊ù) ◊ó◊°◊ô◊û◊™ ◊©◊ù ◊õ◊§◊ï◊ú
        const checked = validateTopicName(topic, "create");
        if (!checked) {
          importFile.value = "";
          return;
        }

        if (data.topics[topic]) {
          alert("Topic already exists. Import cancelled.");
          importFile.value = "";
          return;
        }

        data.topics[topic] = [];

        const reader = new FileReader();
        reader.onload = (ev) => {
          ev.target.result.split(/\r?\n/).forEach((line, i) => {
            if (i === 0) return;

            const p = line.split(",");
            if (p.length >= 2) {
              data.topics[topic].push({
                id: Date.now() + Math.random(),
                learn: p[0].replace(/"/g, ""),
                tr: p.slice(1).join(",").replace(/"/g, ""),
              });
            }
          });

          // üî• ◊©◊û◊ô◊®◊î ◊ï◊¢◊ì◊õ◊ï◊ü
          save();
          loadTopics();
          updateInstructions();

          // üî• ◊ë◊ó◊ô◊®◊™ ◊î◊†◊ï◊©◊ê ◊ï◊§◊™◊ô◊ó◊™ ◊°◊©◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™
          setCurrentTopic(topic);

          importFile.value = "";

          startSessionSafe(topic);    // üî• ◊§◊ï◊™◊ó ◊°◊©◊ü ◊û◊ô◊ô◊ì
        };

        reader.readAsText(file, "UTF-8");
      };

      /* ===== SESSION ===== */

// session state (single source of truth)
let session = [];
let current = null;
let cardFlipped = false;
let shuffleUsed = false;
let sessionDefaultDirection = "A";



function exitSessionSafe(nextScreen) {
  if (stats.current) {
    finishSessionIfActive();
  }

  if (nextScreen) {
    show(nextScreen);
  } else {
    show("home");
  }
}




function startSessionSafe(topicName) {
  // ◊°◊í◊ô◊®◊™ ◊°◊©◊ü ◊ß◊ï◊ì◊ù ◊ê◊ù ◊ß◊ô◊ô◊ù
  if (stats.current) {
    finishSessionIfActive();
  }

  // ◊ë◊ó◊ô◊®◊™ ◊†◊ï◊©◊ê ◊ë◊¶◊ï◊®◊î ◊û◊ë◊ï◊ß◊®◊™
setCurrentTopic(topicName);


  startSession();
}

      function startSession() {
  if (!currentTopic) return;

  // reset session state
  session = [];
  current = null;
  cardFlipped = false;
  shuffleUsed = false;
  sessionDefaultDirection = "A";

  // ----- HARD WORDS -----
  if (currentTopic === "Hard Words") {
    session = Object.entries(stats.hardWords)
      .filter(e => e[1] >= 2)
      .map(e => {
        const [learn, tr] = e[0].split("||");
        return { learn, tr };
      });

    if (session.length === 0) {
      alert("No hard words to practice yet.");
      show("home");
      return;
    }
  }
  // ----- NORMAL TOPIC -----
  else {
    if (!data.topics[currentTopic]) {
      alert("Topic not found.");
      return;
    }

    session = [...data.topics[currentTopic]];

    const sort = sortSelect.value;
    if (sort === "learn") {
      session.sort((a, b) => a.learn.localeCompare(b.learn));
    }
    if (sort === "tr") {
      session.sort((a, b) => a.tr.localeCompare(b.tr));
    }

    if (session.length === 0) {
      alert("This topic has no words.");
      show("bank");
      return;
    }
  }

  // ----- START SESSION -----
  shuffleBtn.classList.remove("hidden");

  stats.sessions++;
  stats.current = {
    topic: currentTopic,
    correct: 0,
    wrong: 0
  };

  nextCard();
}


      function nextCard() {
        if (session.length === 0) {
          stats.history.push(stats.current);
          stats.history = stats.history.slice(-10);

          let t = stats.current.topic;
          if (!stats.perTopic[t]) stats.perTopic[t] = { correct: 0, wrong: 0 };
          stats.perTopic[t].correct += stats.current.correct;
          stats.perTopic[t].wrong += stats.current.wrong;

          save();
          show("sessionEnd");
          return;
        }
        current = session[0];
        cardFlipped = false;
        renderCard();
        show("session");
      }

      function renderCard() {
        let side = cardFlipped
          ? sessionDefaultDirection === "A"
            ? "B"
            : "A"
          : sessionDefaultDirection;

        const text = side === "A" ? current.learn : current.tr;
        card.textContent = text;

        requestAnimationFrame(() => {
          autoFitCardText();
        });

        document.getElementById("remainingCount").textContent = session.length;
      }

      function autoFitCardText() {
        const maxFont = 102; // ◊§◊ô 3
        const minFont = 18;

        let size = maxFont;
        card.style.fontSize = size + "px";

        while (size > minFont) {
          card.style.fontSize = size + "px";

          // ◊ê◊ù ◊ô◊© ◊í◊ú◊ô◊©◊î ‚Äì ◊û◊ß◊ò◊ô◊†◊ô◊ù
          if (
            card.scrollHeight > card.clientHeight ||
            card.scrollWidth > card.clientWidth
          ) {
            size -= 2;
          } else {
            break;
          }
        }
      }

      function flipCard() {
        cardFlipped = !cardFlipped;
        if (soundOn) {
          flipSound.currentTime = 0;
          flipSound.play();
        }
        renderCard();
      }

      function flipDirection() {
        sessionDefaultDirection = sessionDefaultDirection === "A" ? "B" : "A";
        cardFlipped = false;
        renderCard();
      }

      function shuffleSession() {
        if (shuffleUsed) return;

        shuffleUsed = true;
        shuffleBtn.classList.add("hidden");

        session.sort(() => Math.random() - 0.5);

        current = session[0];
        cardFlipped = false;
        renderCard();
      }

      function markKnown() {
        if (soundOn) {
          correctSound.currentTime = 0;
          correctSound.play();
        }
        stats.current.correct++;
        session.shift();
        nextCard();
      }

      function markUnknown() {
        stats.current.wrong++;
        let key = current.learn + "||" + current.tr;
        stats.hardWords[key] = (stats.hardWords[key] || 0) + 1;
        session.push(session.shift());
        nextCard();
      }

      function finishSessionIfActive() {
        if (!stats.current) return;

        stats.history.push(stats.current);

        stats.history = stats.history.slice(-10);

        const t = stats.current.topic;
        if (!stats.perTopic[t]) {
          stats.perTopic[t] = { correct: 0, wrong: 0 };
        }

        stats.perTopic[t].correct += stats.current.correct;
        stats.perTopic[t].wrong += stats.current.wrong;

        stats.current = null;
        save();
      }

      function loadCSVToSession(csvText, topicTitle) {
        session = [];

        csvText.split(/\r?\n/).forEach((line, i) => {
          if (i === 0) return;
          const p = line.split(",");
          if (p.length >= 2) {
            session.push({
              learn: p[0].replace(/"/g, ""),
              tr: p.slice(1).join(",").replace(/"/g, ""),
            });
          }
        });

        if (session.length === 0) return;

        setCurrentTopic(topicTitle);
        sessionDefaultDirection = "A";
        cardFlipped = false;
        shuffleUsed = false;

        stats.sessions++;
        stats.current = { topic: currentTopic, correct: 0, wrong: 0 };

        nextCard();
      }

      /* ===== STATS ===== */
      function renderStats() {
  let topics = Object.keys(data.topics).length;
  let words = allWords().length;

  let topicStats = "";
  Object.keys(stats.perTopic).forEach((t) => {
    let c = stats.perTopic[t].correct;
    let w = stats.perTopic[t].wrong;
    let acc = c + w > 0 ? Math.round((c / (c + w)) * 100) : 0;
    topicStats += `
      <div class="stat-block">
        <strong>Topic: ${t}</strong><br>
        Correct: ${c}<br>
        Wrong: ${w}<br>
        Accuracy: ${acc}%
      </div>`;
  });

  const hardEntries = Object.entries(stats.hardWords)
    .filter((e) => e[1] >= 2)
    .sort((a, b) => b[1] - a[1]);

  const hardTable = hardEntries.length
    ? `
      <h3>Hard Words</h3>
      <table class="hard-table">
        <thead>
          <tr>
            <th>Word</th>
            <th>Times Wrong</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${hardEntries
            .map(([key, count]) => {
              const [learn, tr] = key.split("||");
              const safeKey = key.replace(/'/g, "\\'");
              return `
                <tr>
                  <td class="hard-word">${learn} ‚Äì ${tr}</td>
                  <td class="hard-count">${count}</td>
                  <td style="text-align:right">
                    <button
                      class="button-danger"
                      style="padding:6px 10px;font-size:14px"
                      onclick="removeHardWord('${safeKey}')">
                      Remove
                    </button>
                  </td>
                </tr>`;
            })
            .join("")}
        </tbody>
      </table>`
    : `<h3>Hard Words</h3><p>No hard words</p>`;

  statsContent.innerHTML = `
    <p>Topics: ${topics}</p>
    <p>Words: ${words}</p>
    <p>Sessions started: ${stats.sessions}</p>
    <hr>
    <h3>By topic</h3>
    ${topicStats || "<p>No data</p>"}
    <hr>
    ${hardTable}
  `;
}

function removeHardWord(key) {
  if (!stats.hardWords[key]) return;

  delete stats.hardWords[key];
  save();
  renderStats();
}

      function resetStats() {
        if (!confirm("Reset ALL statistics?")) return;

        stats = {
          sessions: 0,
          history: [],
          perTopic: {},
          hardWords: {},
        };

        localStorage.setItem(STATS_KEY, JSON.stringify(stats));

        renderStats();
      }

      /* ===== MISC ===== */


      /* == reset == */
async function hardReset() {
  localStorage.clear();

  if ("caches" in window) {
    const keys = await caches.keys();
    await Promise.all(keys.map(k => caches.delete(k)));
  }

  if ("serviceWorker" in navigator) {
    const regs = await navigator.serviceWorker.getRegistrations();
    await Promise.all(regs.map(r => r.unregister()));
  }

  localStorage.setItem(RESET_FLAG, "1");
  location.reload();
}


      function toggleAccordion(header) {
        const acc = header.parentElement;
        const container = acc.parentElement; // #downloadAccordions ◊ê◊ï #bank (◊ê◊ù ◊ë◊¢◊™◊ô◊ì)

        // ◊°◊í◊ô◊®◊™ ◊õ◊ú ◊î◊ê◊ß◊ï◊®◊ì◊ô◊ï◊†◊ô◊ù ◊ë◊ê◊ï◊™◊ï ◊û◊°◊ö
        container.querySelectorAll(".accordion.open").forEach((a) => {
          if (a !== acc) a.classList.remove("open");
        });

        // toggle ◊®◊ß ◊©◊ú ◊î◊†◊ï◊õ◊ó◊ô
        acc.classList.toggle("open");
      }

      const restartBtn = document.getElementById("restartSessionBtn");
if (restartBtn) {
  restartBtn.onclick = () => {
    shuffleUsed = false;
    startSession();
  };
}

const backBtn = document.getElementById("backHomeBtn");
if (backBtn) {
  backBtn.onclick = () => {
    goHome();
  };
}


      /* ===== DOWNLOAD ===== */

      async function buildDownloadUI() {
        if (!hubIndex || !currentDownloadLang) return;

        const container = document.getElementById("downloadAccordions");
        container.innerHTML = "";

        const { groups, topics } = hubIndex;

        for (const group of groups) {
          const acc = document.createElement("div");
          acc.className = "accordion";

          acc.innerHTML = `
      <div class="accordion-header" onclick="toggleAccordion(this)">
        ${group.title} <span>‚ñ∂</span>
      </div>
      <div class="accordion-content">
        <ul></ul>
      </div>
    `;

          const ul = acc.querySelector("ul");
          let hasAnyFiles = false;

          topics
            .filter((t) => t.group === group.id)
            .forEach((topic) => {
              const files = topic.files?.[currentDownloadLang];

              const li = document.createElement("li");
              li.textContent = topic.title;

              if (files && files.length) {
                hasAnyFiles = true;
                li.classList.add("li-available");

                
li.onclick = () => {
  const fileName = files[0];
  const path =
    `hub/${currentDownloadLang}/${topic.id}/${fileName}`;

  onDownloadFile(path, topic.title, fileName);
};

              } else {
                li.classList.add("li-locked");
              }

              ul.appendChild(li);
            });

          // üî• ◊¶◊ë◊¢ ◊õ◊ï◊™◊®◊™ ◊®◊ß ◊ê◊ù ◊ô◊© ◊ß◊ë◊¶◊ô◊ù ◊ë◊ß◊ë◊ï◊¶◊î
          if (hasAnyFiles) {
            acc.classList.add("accordion-has-files");
          }

          container.appendChild(acc);
        }
      }

      async function onDownloadFile(path, topicTitle, fileName) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);

        try {
          const res = await fetch(path, { signal: controller.signal });
          if (!res.ok) {
            alert("File not found");
            return;
          }

          const text = await res.text();

          const appTopicName = `${topicTitle} ‚Äì ${fileName.replace(/\.csv$/i, "")}`;

          const ok = saveCSVAsTopic(text, appTopicName);
          if (!ok) return;

          setCurrentTopic(appTopicName);
          topicSelect.value = appTopicName;

          startSessionSafe(appTopicName);
        } catch (e) {
          alert("Download timeout. Try again.");
        } finally {
          clearTimeout(timeoutId);
        }
      }

      /* ===== DOWNLOAD LANGUAGE SELECTION ===== */

      let currentDownloadLang = null;
      const downloadLangSelect = document.getElementById("downloadLangSelect");

      if (downloadLangSelect) {
        downloadLangSelect.addEventListener("change", () => {
          currentDownloadLang = downloadLangSelect.value || null;
          markActiveDownloadLang();
          buildDownloadUI(); // üî• ◊ó◊ï◊ë◊î
          closeAllAccordions(); // ◊†◊ô◊ß◊ï◊ô ◊û◊¶◊ë ◊ß◊ï◊ì◊ù
        });
      }

      function markActiveDownloadLang() {
        downloadLangSelect.classList.remove(
          "lang-he-en",
          "lang-pl-en",
          "lang-ar-he",
          "lang-es-he",
        );

        const acc = document.getElementById("downloadAccordions");

        if (currentDownloadLang) {
          downloadLangSelect.classList.add("lang-" + currentDownloadLang);
          if (acc) acc.classList.remove("lang-not-selected");
        } else {
          if (acc) acc.classList.add("lang-not-selected");
        }
      }

      function closeAllAccordions() {
        document
          .querySelectorAll("#download .accordion.open")
          .forEach((acc) => acc.classList.remove("open"));
      }

      function exitApp() {
        // PWA / Mobile
        if (navigator.userAgent.includes("Android")) {
          navigator.app?.exitApp?.();
        }

        // ◊ì◊§◊ì◊§◊ü ◊®◊í◊ô◊ú ‚Äì ◊ó◊ñ◊®◊î ◊ê◊ó◊ï◊®◊î
        window.history.back();
      }



       function gateUntilReset() {
  if (localStorage.getItem(RESET_FLAG)) return;

  document
    .querySelectorAll(".screen")
    .forEach(s => s.classList.remove("active"));

  document.getElementById("resetGate").classList.add("active");
}




      /* ===== INIT ===== */
      (() => {

gateUntilReset();


        hubIndex = window.HUB_INDEX || null;

        loadTopics();
        updateInstructions();
      })();




    </script>
  </body>
</html>